<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaxChat - Chat</title>
    <!-- PWA & Mobile Settings -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#008069">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MaxChat">

<!-- App Icon for iOS (iPhone) -->
<link rel="apple-touch-icon" href="https://i.postimg.cc/wjSGxVG2/logo-short-removebg.png">

<!-- Service Worker Registration -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker failed', err));
        });
    }
</script>
    <style>
        :root { --primary: #008069; --light: #e5ddd5; --me: #dcf8c6; --them: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header */
        .header { background: #008069; padding: 10px 15px; display: flex; align-items: center; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .back-btn { text-decoration: none; color: white; font-size: 1.2em; margin-right: 10px; }
        .friend-info { display: flex; align-items: center; }
        .friend-pic { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; background: #ccc; }
        
        /* Chat Area */
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 15px; position: relative; font-size: 0.95em; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.me { align-self: flex-end; background: var(--me); border-top-right-radius: 0; }
        .msg.them { align-self: flex-start; background: var(--them); border-top-left-radius: 0; }
        
        /* Input Area */
        .input-area { background: white; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .input-area input { flex: 1; padding: 12px; border-radius: 25px; border: none; background: #f0f0f0; outline: none; }
        .send-btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-btn">←</a>
        <div class="friend-info">
            <img src="" id="fPic" class="friend-pic">
            <strong id="fName">Loading...</strong>
        </div>
    </div>

    <div class="chat-area" id="chatBox">
        <div style="text-align:center; color:#888; margin-top:20px;">Loading chats...</div>
    </div>

    <div class="input-area">
        <input type="text" id="msgInput" placeholder="Type a message">
        <button class="send-btn" onclick="sendMsg()">➤</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxHFY54vZ8o0WO7J9SD0d9vL6MOQKe35Wd-r0UCC5qYF_4VAKYcMgDxtTKWJfbwpDZGKQ/exec"; 
        const myUser = sessionStorage.getItem("maxchat_user");
        const urlParams = new URLSearchParams(window.location.search);
        const friendUser = urlParams.get('friend');
        const friendName = urlParams.get('name') || friendUser; // Fallback

        if(!myUser) window.location.href = "login.html";

        document.getElementById('fName').innerText = friendName;
        // Ideally fetch friend pic here, but using placeholder for speed or passed URL param
        document.getElementById('fPic').src = "https://i.postimg.cc/br7WQM9z/man-avatar.png"; 

        const chatBox = document.getElementById('chatBox');
        let currentMsgCount = 0;

        function refreshChat() {
            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getChat", u1: myUser, u2: friendUser })
            })
            .then(res => res.json())
            .then(data => {
                if(data.chats.length !== currentMsgCount) {
                    chatBox.innerHTML = "";
                    data.chats.forEach(c => {
                        let div = document.createElement('div');
                        div.className = c.sender === myUser ? "msg me" : "msg them";
                        div.innerText = c.msg;
                        chatBox.appendChild(div);
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                    currentMsgCount = data.chats.length;
                }
            });
        }

        function sendMsg() {
            const input = document.getElementById('msgInput');
            const msg = input.value;
            if(!msg) return;

            // Optimistic UI update (Show immediately)
            let div = document.createElement('div');
            div.className = "msg me";
            div.innerText = msg;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            input.value = "";

            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "sendMessage", sender: myUser, receiver: friendUser, message: msg })
            });
        }

        // Initial Load and Polling
        refreshChat();
        setInterval(refreshChat, 3000); // Check every 3 seconds

        // Enter key to send
        document.getElementById("msgInput").addEventListener("keyup", function(event) {
            if (event.key === "Enter") sendMsg();
        });
    </script>
</body>
</html>